import { AudioManager } from './audio-manager';
import { CoffeeCup } from './coffee-cup';
import { AbstractCoffeeMachineUI } from './abstract-coffee-machine-ui';

export class CoffeeMachineGUI extends AbstractCoffeeMachineUI {
  private audioManager: AudioManager;
  private buttonElements: HTMLCollectionOf<Element>;
  private switchOnButton: Element;
  private coffeeMachineElement: Element;
  private ingredientContainers: HTMLCollectionOf<Element>;
  private buttonElementsNav: Element;
  private cup: CoffeeCup;
  // private hinter: Hints;
  private boundHandlerOnSelectedCoffee: (e: Event) => void;

  constructor({ hints }: { hints?: boolean }) {
    super();
    this.audioManager = new AudioManager({ volume: 0.5 });
    this.buttonElements = document.getElementsByClassName('button');
    this.switchOnButton = Array.prototype.filter.call(this.buttonElements, (button) =>
      button.classList.contains('button_is-switch-on'),
    )[0];
    this.coffeeMachineElement = document.getElementsByClassName('coffee-machine')[0]
    this.ingredientContainers = document.getElementsByClassName('container');
    this.buttonElementsNav = document.getElementsByClassName('coffee-list')[0];
    this.cup = new CoffeeCup({
      cupElement: document.getElementsByClassName('coffee-cup-factor')[0],
      pouredLiquidElement: document.getElementsByClassName('coffee-cup')[0],
    });
    // this.hinter = hints ? new Hints(
    //   [this._switchOnButton, ...this._ingredientContainers, this._cup.cupElement],
    // ) : null;
    this.boundHandlerOnSelectedCoffee = this.handlerOnSelectedCoffee.bind(this);
    this.setupControlsHandlers();
  }

  setupEvents(machine) {
    machine.onEvents({
      'coffeeReady': (ingredientsAvailable) => {
        this.stopAnimation('busy');
        this.enableAllButtons();
        this.audioManager.stop('grindCoffeeBeansSound');
        this.setupOnMakeCoffeeTypesOnEventClick();
        console.log('–ö–æ—Ñ–µ –≥–æ—Ç–æ–≤!');
        this.audioManager.stop('pouringCoffeeSound');
        this.showIngredientsAvailable(ingredientsAvailable);
        this.renderIngredientsAvailable(ingredientsAvailable);
      },
      'noAnythingIngredient': () => {
        this.stopAnimation('busy');
        this.startAnimation('error');
      },
      'noMilk': () => {
        console.log('–∫–∞–∂–µ—Ç—Å—è –Ω–µ—Ç –º–æ–ª–æ–∫–∞');
        // this.stopAnimation('busy');
        // this.startAnimation('error');
        this.showContainerStatus('milk');
        this.fillContainer('milk');
      },
      'noGrains': () => {
        console.log('–Ω–µ—Ç –∑–µ—Ä–µ–Ω');
        // this.stopAnimation('busy');
        // this.startAnimation('error');
        this.showContainerStatus('grain');
        this.fillContainer('grain');
      },
      'noWater': () => {
        console.log('–Ω–µ—Ç –≤–æ–¥—ã');
        // this.stopAnimation('busy');
        // this.startAnimation('error');
        this.showContainerStatus('water');
        this.fillContainer('water');
      },
      'replenishmentOfIngredients': (data) => {
        if (Object.values(data).every(ingredientAmount => ingredientAmount > 10)) {
          this.stopAnimation('error');
          this.emit('filledAllContainers')
        }
      },
      'returnCoffeeTypes': (coffeeTypes) => {
        this.showTypesCoffee(coffeeTypes);
        this.enableAllButtons();
        this.setupOnMakeCoffeeTypesOnEventClick();
      },
      'whipping': () => {
        console.log('–≤–∑–±–∏–≤–∞—é üåÄ...');
      },
      'pouring': ({ colorCoffee, ms }) => {
        this.startPouringDrinkAnimation(ms, colorCoffee);
        this.audioManager.play('pouringCoffeeSound');
        console.log('–Ω–∞–ª–∏–≤–∞—é ü•õ...');
      },
      'cleaning': () => {
        console.log('–æ—á–∏—â–∞—é...');
      },
      'clear': () => {
        console.log('–æ—á–∏—Å—Ç–∏–ª üßπ');
      },
      'canOff': () => {
        // ???? //
        this.setupSwitchOffHandler();
      },
      'ready': (coffeeTypes) => {
        this.showTypesCoffee(coffeeTypes);
        this.stopAnimation('busy');
        this.setupOnMakeCoffeeTypesOnEventClick();
        this.setupSwitchOffHandler();
        console.log('—è –≥–æ—Ç–æ–≤–∞ –¥–µ–ª–∞—Ç—å –∫–æ—Ñ–µ!');
      },
      'on': () => {
        this.coffeeMachineElement.classList.remove('off')
      },
      'off': () => {
        this.removeOnMakeCoffeeTypesOnEventClick();
        this.switchOnButton.setAttribute('aria-checked', 'false');
        this.coffeeMachineElement.classList.add('off');
        this.setupControlsHandlers();
        console.log('\n\n\n\n\n\n\n\n');
      },
      'checking': (cupIsFull) => {
        console.log('–ø—Ä–æ–≤–µ—Ä—è—é...');
        if (cupIsFull) {
          this.cup.pouredLiquidElement.classList.remove('pouring-mode');
        }
        this.startAnimation('busy');
      },
      'brewing': ({ coffeeType }) => {
        this.audioManager.play('grindCoffeeBeansSound');
        console.log(`–∑–∞–≤–∞—Ä–∏–≤–∞—é ${coffeeType.coffeeName}`);
      },
      'welcome': (coffeeTypes) => this.greeting(coffeeTypes),
      'init': (ingredientsAvailable) => {
        this.showIngredientsAvailable(ingredientsAvailable);
        this.renderIngredientsAvailable(ingredientsAvailable);
      }
    });
  }

  renderIngredientsAvailable(ingredientsAvailable) {
    Array.prototype.map.call(document.getElementsByClassName('container'), (container) => {
      for (const name of Reflect.ownKeys(ingredientsAvailable)) {
        const ingredient = container.getElementsByClassName(`${String(name)}`)[0];
        if (ingredient) {
          ingredient.style.clipPath = `polygon(0 ${100 - ingredientsAvailable[name]}%,
          100% ${100 - ingredientsAvailable[name]}%, 100% 100%, 0 100%)`;
        }
      }
    });
  }

  fillContainer(containerName) {
    Array.prototype.find.call(
      this.ingredientContainers,
      (container => container.children[0].dataset.containerName === containerName)
    )
    .addEventListener('click', () => {
      let amountOf = +prompt('–°–∫–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç—å?', '100')
      if (amountOf > 100 || amountOf === null) {
        amountOf = 100;
      }

      this.renderInfoContainer(containerName, amountOf)

      this.showContainerStatus(containerName);
      this.audioManager.play('fillingContainerSound');
      console.log(`–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ ${containerName}: ${amountOf}`)
      this.emit('filledContainer', { containerName, amountOf })
    })
  }

  renderInfoContainer(containerName: string, amountOf: number) {
    const container = <HTMLElement>document.getElementsByClassName(containerName)[0]
    document.getElementsByClassName(`coffee-machine__${containerName}`)[0]
      .textContent = String(containerName + ": " + amountOf);
    container.style
      .clipPath = `polygon(0 ${100 - amountOf}%, 100% ${100 - amountOf}%, 100% 100%, 0 100%)`;
  }

  showIngredientsAvailable(ingredientsAvailable) {
    const listIngredients = document.getElementsByClassName('information')[0];
    const itemsIngredient = listIngredients.children;
    for (const ingName of Object.keys(ingredientsAvailable)) {
      if (ingredientsAvailable.hasOwnProperty(ingName)) {
        Array.prototype.forEach.call(itemsIngredient, (item) =>
          item.dataset.name === ingName ? (item.textContent = `${ingName}: ${ingredientsAvailable[ingName]}`) : '',
        );
      }
    }
  }

  setupOnMakeCoffeeTypesOnEventClick() {
    this.buttonElementsNav.addEventListener('click', this.boundHandlerOnSelectedCoffee);
  }

  removeOnMakeCoffeeTypesOnEventClick() {
    this.buttonElementsNav.removeEventListener('click', this.boundHandlerOnSelectedCoffee);
  }

  handlerOnSelectedCoffee(e) {
    console.clear();
    if (e.target.type === 'button') {
      this.startAnimation('busy');
      this.disableAllButtons(e);
      this.removeOnMakeCoffeeTypesOnEventClick();

      this.emit('coffeeSelected', e.target.textContent);
    }
  }

  disableAllButtons(e) {
    Array.prototype.forEach.call(e.currentTarget.getElementsByTagName('button'), (button) => (button.disabled = true));
  }

  enableAllButtons() {
    Array.prototype.forEach.call(
      this.buttonElementsNav.getElementsByTagName('button'),
      (button) => (button.disabled = false),
    );
  }

  startAnimation(type) {
    this.switchOnButton.classList.add(`${type}-mode`);
  }

  stopAnimation(type) {
    this.switchOnButton.setAttribute('aria-checked', 'true');
    this.switchOnButton.classList.remove(`${type}-mode`);
  }

  startPouringDrinkAnimation(ms, colorCoffee) {
    this.cup.pouredLiquidElement.style.fill = colorCoffee;
    this.cup.pouredLiquidElement.classList.add('pouring-mode');
    this.cup.pouredLiquidElement.style.animationDuration = `${ms}ms`;
  }

  setupControlsHandlers() {
    Array.prototype.forEach.call(this.buttonElements, (button) =>
      button.addEventListener('click', this.audioManager.play.bind(this.audioManager, 'clickButtonsSound')),
    );

    this.switchOnButton.addEventListener(
      'click',
      () => {
        this.eventHandlers.switchOn.forEach((handler) => handler());
      },
      { once: true },
    );
    //
    // document.getElementsByClassName('button-clean-waste')[0]
    // .addEventListener('click',
    //   () => this._eventHandlers.cleanUp.forEach((handler) => handler()));
  }

  setupSwitchOffHandler() {
    this.switchOnButton.addEventListener(
      'click',
      () => {
        this.eventHandlers.switchOff.forEach((handler) => handler());
      },
      { once: true },
    );
  }

  showContainerStatus(containerName) {
    const targetContainer = Array.prototype.find.call(
      document.getElementsByClassName('container-inner'),
      (container) => container.dataset.containerName === containerName
    )

    // –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —Ç–æ–≥–ª–∏—Ç—å !!!! –Ω–µ—Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ !!!!

    targetContainer.classList.toggle('error-mode');
  }

  showIngredients(ingredientsAvailable) {
    this.renderIngredientsAvailable(ingredientsAvailable);
    this.showIngredientsAvailable(ingredientsAvailable);
  }

  greeting({coffeeTypes}) {
    console.log(`
      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
      –û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å –Ω–∞—à–∏–º –º–µ–Ω—é:
      ${coffeeTypes.join(', ')}
      –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø–∏—Ç–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–µ—Ç–µ –µ–≥–æ –≤ –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
      –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!
    `);
  }

  showTypesCoffee(coffeeTypes) {
    if (this.buttonElementsNav.childElementCount === 0) {
      const coffeeListElement = this.buttonElementsNav;

      coffeeTypes.forEach((coffeeName) => {
        const buttonElement = document.createElement('button');
        buttonElement.type = 'button';
        const listItemElement = document.createElement('li');
        buttonElement.textContent = coffeeName;
        listItemElement.appendChild(buttonElement);
        coffeeListElement.appendChild(listItemElement);
      });
    }
  }
}
